<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Ilmpay</title>
    
    <!-- 📊 ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- 🎨 Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    
    <!-- Other resources -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 🎭 GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    
    <!-- Local resources -->
    <link rel="stylesheet" href="/css/admin.css">
    <script src="/js/main.js" type="module" defer></script>
    <script src="/js/admin.js" type="module" defer></script>
    
    <!-- Additional styles -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex">
        <!-- Include Sidebar -->
        <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>
        
        <!-- Main Content -->
        <main class="flex-1 p-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6">
                <!-- 👥 Total Visitors -->
                <div class="col-span-1 md:col-span-2" data-aos="zoom-in" data-aos-delay="100">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm">Total Visitors</p>
                                <p class="text-3xl font-bold mt-2" th:text="${totalVisitors}">15,487</p>
                                <p class="text-xs mt-1 opacity-75 rate-change" data-change="visitorChange"></p>
                            </div>
                            <i data-lucide="users" class="w-12 h-12 opacity-75"></i>
                        </div>
                    </div>
                </div>
                
                <!-- 🎯 Today's Visitors -->
                <div class="col-span-1" data-aos="zoom-in" data-aos-delay="200">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm">Today's Visitors</p>
                                <p class="text-3xl font-bold mt-2" th:text="${todayVisitors}">234</p>
                                <p class="text-xs mt-1 opacity-75 rate-change" data-change="activeChange"></p>
                            </div>
                            <i data-lucide="user-plus" class="w-12 h-12 opacity-75"></i>
                        </div>
                    </div>
                </div>

                <!-- 📱 Active Users -->
                <div class="col-span-1" data-aos="zoom-in" data-aos-delay="300">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm">Active Users</p>
                                <p class="text-3xl font-bold mt-2" th:text="${activeUsers}">7,256</p>
                                <p class="text-xs mt-1 opacity-75 rate-change" data-change="durationChange"></p>
                            </div>
                            <i data-lucide="user-check" class="w-12 h-12 opacity-75"></i>
                        </div>
                    </div>
                </div>

                <!-- 🔄 Bounce Rate -->
                <div class="col-span-1" data-aos="zoom-in" data-aos-delay="400">
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm">Bounce Rate</p>
                                <p class="text-3xl font-bold mt-2" id="bounceRate">32.5%</p>
                                <p class="text-xs mt-1 opacity-75 rate-change" data-change="bounceChange"></p>
                            </div>
                            <i data-lucide="shuffle" class="w-12 h-12 opacity-75"></i>
                        </div>
                    </div>
                </div>

                <!-- ⏱️ Avg Session -->
                <div class="col-span-1" data-aos="zoom-in" data-aos-delay="500">
                    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm">Avg Session</p>
                                <p class="text-3xl font-bold mt-2" id="avgSessionDuration">8m 45s</p>
                                <p class="text-xs mt-1 opacity-75 rate-change" data-change="durationChange"></p>
                            </div>
                            <i data-lucide="clock" class="w-12 h-12 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Visitor Trends Chart -->
                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Visitor Trends</h3>
                        <div class="select-container">
                            <select id="visitorTrendsPeriod" class="custom-select" onchange="updateVisitorStats(this.value)">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-64" id="visitorChart"></div>
                </div>
                
                <!-- Activity Heatmap -->
                <div class="bg-white rounded-xl p-6 shadow-sm border">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold flex items-center space-x-2">
                            <i data-lucide="activity" class="w-5 h-5 text-indigo-600"></i>
                            <span>User Activity Heatmap</span>
                        </h3>
                        <div class="select-container">
                            <select id="heatmapPeriod" class="custom-select" onchange="updateHeatmap(this.value)">
                            <option value="7" selected>Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30">Last 30 days</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-64" id="heatmapChart"></div>
                </div>
            </div>

            <!-- Content Management Section -->
            <div th:replace="~{admin/content/index :: content-management}"></div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();

            // Visitor Chart Configuration
            const visitorData = {
                chart: {
                    type: 'area',
                    height: 256,
                    toolbar: { show: false },
                    zoom: { enabled: false }
                },
                series: [{
                    name: 'Daily Visitors',
                    data: []
                }],
                xaxis: {
                    type: 'datetime',
                    labels: {
                        format: 'dd MMM',
                        style: { colors: '#718096' }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: val => Math.floor(val),
                        style: { colors: '#718096' }
                    }
                },
                colors: ['#4F46E5'],
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.45,
                        opacityTo: 0.05,
                        stops: [50, 100, 100]
                    }
                },
                stroke: { width: 2 },
                tooltip: {
                    theme: 'dark',
                    x: { format: 'dd MMM yyyy' }
                }
            };

            // Heatmap Configuration
            const heatmapData = {
                chart: {
                    height: 350,
                    type: 'heatmap',
                    toolbar: { show: false },
                    fontFamily: 'Inter, sans-serif',
                    background: '#fff',
                    animations: {
                        speed: 500
                    }
                },
                series: [],
                plotOptions: {
                    heatmap: {
                        enableShades: true,
                        distributed: true,
                        colorScale: {
                            ranges: [
                                { from: 0, to: 15, name: 'Very Low', color: '#F3F4F6' },
                                { from: 16, to: 30, name: 'Low', color: '#93C5FD' },
                                { from: 31, to: 50, name: 'Medium', color: '#3B82F6' },
                                { from: 51, to: 75, name: 'High', color: '#1D4ED8' },
                                { from: 76, to: 100, name: 'Peak', color: '#1E3A8A' }
                            ]
                        }
                    }
                },
                dataLabels: { enabled: false },
                xaxis: {
                    categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                },
                yaxis: {
                    reversed: true
                }
            };

            // Initialize charts with empty data first
            const visitorChart = new ApexCharts(document.querySelector('#visitorChart'), visitorData);
            visitorChart.render();

            const heatmapChart = new ApexCharts(document.querySelector('#heatmapChart'), heatmapData);
            heatmapChart.render();

            // Helper function to format rate changes
            function formatRateChange(change, type = 'increase') {
                const isNegative = change < 0;
                const arrow = isNegative ? '↓' : '↑';
                const absChange = Math.abs(change).toFixed(1);
                
                let description;
                switch(type) {
                    case 'bounce':
                        description = isNegative ? 'improvement' : 'increase';
                        break;
                    case 'duration':
                        description = 'from last period';
                        break;
                    default:
                        description = 'from last period';
                }
                
                return `${arrow} ${absChange}% ${description}`;
            }

            // Helper function to update rate changes display
            function updateRateChanges(data) {
                document.querySelectorAll('.rate-change').forEach(element => {
                    const changeType = element.dataset.change;
                    const value = data[changeType];
                    
                    if (value !== undefined) {
                        const type = changeType === 'bounceChange' ? 'bounce' : 
                                   changeType === 'durationChange' ? 'duration' : 'increase';
                        
                        element.textContent = formatRateChange(value, type);
                        element.classList.remove('text-green-400', 'text-red-400');
                        
                        // Add color based on whether the change is good or bad
                        if (changeType === 'bounceChange') {
                            element.classList.add(value < 0 ? 'text-green-400' : 'text-red-400');
                        } else {
                            element.classList.add(value >= 0 ? 'text-green-400' : 'text-red-400');
                        }
                    }
                });
            }

            // Function to fetch and update visitor stats
            async function updateVisitorStats(days = 30) {
                try {
                    const response = await fetch(`/api/analytics/visitor-stats?days=${days}`);
                    const data = await response.json();
                    
                    const series = [{
                        name: 'Daily Visitors',
                        data: data.dailyVisitors.map(point => [
                            new Date(point.date).getTime(),
                            point.visitors
                        ])
                    }];
                    
                    visitorChart.updateSeries(series);

                    // Update stats and rates
                    const bounceRate = data.bounceRate != null ? Math.round(data.bounceRate) : 0;
                    const avgDuration = data.avgSessionDuration != null ? data.avgSessionDuration : 0;
                    
                    const bounceRateElement = document.getElementById('bounceRate');
                    const avgSessionElement = document.getElementById('avgSessionDuration');
                    
                    if (bounceRate > 0 || bounceRateElement.textContent === '0%') {
                        bounceRateElement.textContent = `${bounceRate}%`;
                    }
                    
                    if (avgDuration > 0 || avgSessionElement.textContent === '0m') {
                        avgSessionElement.textContent = formatDuration(avgDuration);
                    }

                    // Update rate changes
                    updateRateChanges(data);
                } catch (error) {
                    console.error('Error fetching visitor stats:', error);
                    // Don't update values on error to preserve existing data
                }
            }

            // Function to fetch and update heatmap data
            async function updateHeatmap(days = 7) {
                try {
                    const response = await fetch(`/api/analytics/activity-heatmap?days=${days}`);
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    const transformedData = transformHeatmapData(data);
                    heatmapChart.updateSeries(transformedData);
                } catch (error) {
                    console.error('Error fetching heatmap data:', error);
                    // Set empty data with proper structure when API fails
                    const emptyData = generateEmptyHeatmapData();
                    heatmapChart.updateSeries(emptyData);
                }
            }

            // Helper function to generate empty heatmap data
            function generateEmptyHeatmapData() {
                return Array.from({ length: 8 }, (_, i) => ({
                    name: `${String(i * 3).padStart(2, '0')}:00-${String((i * 3) + 3).padStart(2, '0')}:00`,
                    data: Array(7).fill(0)
                }));
            }

            // Helper function to transform heatmap data
            function transformHeatmapData(data) {
                if (!data || !Array.isArray(data)) {
                    return generateEmptyHeatmapData();
                }

                const timeBlocks = [];
                for (let hour = 0; hour < 24; hour += 3) {
                    timeBlocks.push({
                        name: `${String(hour).padStart(2, '0')}:00-${String(hour + 3).padStart(2, '0')}:00`,
                        data: Array(7).fill(0) // Initialize with zeros for each day
                    });
                }

                // Fill in actual data
                data.forEach(point => {
                    if (point && typeof point.hour === 'number' && typeof point.dayOfWeek === 'number') {
                        const blockIndex = Math.floor(point.hour / 3);
                        // PostgreSQL's EXTRACT(DOW) returns 0-6 for Sun-Sat, we need 1-7 for Mon-Sun
                        const dayIndex = (point.dayOfWeek + 6) % 7; // Convert Sunday=0 to Sunday=6
                        if (timeBlocks[blockIndex]) {
                            timeBlocks[blockIndex].data[dayIndex] = point.count || 0;
                        }
                    }
                });

                return timeBlocks;
            }

            // Helper function to format duration
            function formatDuration(seconds) {
                if (!seconds) return '0m';
                const minutes = Math.round(seconds / 60);
                if (minutes < 60) return `${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}m` : `${hours}h`;
            }

            // Make functions globally available
            window.updateVisitorStats = updateVisitorStats;
            window.updateHeatmap = updateHeatmap;

            // Initial load
            updateVisitorStats();
            updateHeatmap();

            // Refresh every 5 minutes
            setInterval(() => {
                updateVisitorStats();
                updateHeatmap();
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
